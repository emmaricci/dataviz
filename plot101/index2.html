<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap"
    rel="stylesheet"
  />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <title>Music</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    svg {
      outline: thin dashed red;
      background-color: white;
    }
    text {
      font-size: 30px;
      font-family: "Lato", sans-serif;
    }
  </style>
</head>
<body>
  <script>
    // Advanced Data Visualization (QSS 19) Spring 2024
    // Homework 3, Exercise 5, Problem 2 - D3 with Imported Data
    // Name: Emma Ricci-De Lucca

    d3.json('./music.json') // ✅ Assumes JSON, not CSV
      .then(function(data) {
        const height = window.innerHeight;
        const width = window.innerWidth;

        const margin = {
          top: 120,
          right: 150,
          bottom: 130,
          left: 150
        };

        const svg = d3.select('body')
          .append('svg')
          .attr('width', width)
          .attr('height', height);

        // ✅ Ensure numeric conversion
        data = data.map(d => ({
          year: +d.year,
          weeks_chart: +d.weeks_chart,
          position_peak: +d.position_peak,
          rock_genrez: d.rock_genrez
        }));

        const xValue = d => d.year;
        const yValue = d => d.weeks_chart;
        const zValue = d => d.position_peak;

        const x = d3.scaleLinear()
          .domain([1957, 2020])
          .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
          .domain([-3, 48])
          .range([height - margin.bottom, margin.top]);

        const z = d3.scaleLinear()
          .domain(d3.extent(data, zValue))
          .range([1, 30]);

        const keys = ["classic", "country rock", "british"];
        const colorz = ["#fcba03", "#ff6970", "#8ec74f"];
        const myColor = d3.scaleOrdinal().domain(keys).range(colorz);

        const points = data.map(d => ({
          x: x(xValue(d)),
          y: y(yValue(d)),
          z: z(zValue(d)),
          genre: d.rock_genrez
        }));

        const highlight = function (event, genre) {
          d3.selectAll(".circle").style("opacity", 0.25);
          d3.selectAll("." + genre).style("opacity", 1);
        };

        const noHighlight = function () {
          d3.selectAll(".circle").style("opacity", 1);
        };

        const circlesGroup = svg.append("g");

        circlesGroup.selectAll('circle')
          .data(points)
          .enter()
          .append('circle')
          .attr('cx', d => d.x)
          .attr('cy', d => d.y)
          .attr('r', d => d.z)
          .attr("class", d => "circle " + d.genre)
          .attr('fill', d => myColor(d.genre))
          .attr('fill-opacity', 0.85)
          .attr('stroke', 'black');

        // Labels and axes
        const xlabel = "Year";
        const ylabel = "Weeks on the chart";
        const title = "Popularity of Rock Genres Over Time";

        svg.append('g')
          .attr('transform', `translate(${margin.left},0)`)
          .call(d3.axisLeft(y));

        svg.append("text")
          .attr("class", "y label")
          .attr("text-anchor", "end")
          .attr("x", -200)
          .attr("y", 40)
          .attr("dy", ".75em")
          .attr("transform", "rotate(-90)")
          .text(ylabel);

        svg.append('g')
          .attr('transform', `translate(0,${height - margin.bottom})`)
          .call(d3.axisBottom(x).tickFormat(d3.format("d")));

        svg.append("text")
          .attr("class", "x label")
          .attr("text-anchor", "middle")
          .attr("x", width / 2)
          .attr("y", height - 50)
          .text(xlabel);

        svg.append("text")
          .attr("x", 50)
          .attr("y", 50)
          .text(title);

        // Legend
        const legend = svg.selectAll(".legend")
          .data(keys)
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", (d, i) => `translate(${(i * 130) + 110}, -50)`);

        legend.append("circle")
          .attr("cx", -50)
          .attr("cy", 125)
          .attr("r", 7)
          .style("fill", d => myColor(d))
          .on("mouseover", highlight)
          .on("mouseleave", noHighlight);

        legend.append("text")
          .attr("x", -38)
          .attr("y", 125)
          .text(d => d)
          .attr("text-anchor", "left")
          .style("alignment-baseline", "middle")
          .style("font-size", "13px")
          .style("font-family", "Helvetica");

        let totalWidth = 0;
        svg.selectAll('g.legend')
          .each(function () {
            const current = d3.select(this);
            current.attr('transform', `translate(${totalWidth + 110}, -50)`);
            totalWidth += current.node().getBBox().width + 5;
          });
      })
      .catch(function (error) {
        console.error("Data loading error:", error);
      });
  </script>
</body>
</html>
